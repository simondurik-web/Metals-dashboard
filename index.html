<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENTECH | Metal Sales Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --tron-cyan: #00d4ff;
            --tron-blue: #0088ff;
            --tron-dark-blue: #003366;
            --tron-purple: #7b2fff;
            --tron-pink: #ff00ff;
            --tron-orange: #ff6600;
            --tron-green: #00ff88;
            --tron-red: #ff3366;
            --bg-dark: #0a0a0f;
            --bg-card: rgba(0, 20, 40, 0.6);
            --text-primary: #ffffff;
            --text-secondary: #88ccff;
            --glow-cyan: 0 0 20px rgba(0, 212, 255, 0.5), 0 0 40px rgba(0, 212, 255, 0.3);
            --glow-blue: 0 0 20px rgba(0, 136, 255, 0.5), 0 0 40px rgba(0, 136, 255, 0.3);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated grid background */
        .grid-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        /* Mouse follower glow */
        .mouse-glow {
            position: fixed;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 212, 255, 0.15) 0%, rgba(0, 136, 255, 0.05) 40%, transparent 70%);
            pointer-events: none;
            transform: translate(-50%, -50%);
            transition: opacity 0.3s ease;
            z-index: 1;
        }

        .app-container {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 30px 20px;
            margin-bottom: 30px;
        }

        .logo {
            font-family: 'Orbitron', monospace;
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 900;
            letter-spacing: 0.3em;
            background: linear-gradient(135deg, var(--tron-cyan) 0%, var(--tron-blue) 50%, var(--tron-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: var(--glow-cyan);
            animation: logoGlow 3s ease-in-out infinite;
        }

        @keyframes logoGlow {
            0%, 100% { filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.8)); }
            50% { filter: drop-shadow(0 0 40px rgba(0, 212, 255, 1)); }
        }

        .subtitle {
            font-family: 'Orbitron', monospace;
            font-size: clamp(0.7rem, 2vw, 1rem);
            color: var(--text-secondary);
            letter-spacing: 0.5em;
            margin-top: 10px;
            text-transform: uppercase;
        }

        .current-period {
            font-family: 'Orbitron', monospace;
            font-size: clamp(0.9rem, 2.5vw, 1.2rem);
            color: var(--tron-cyan);
            margin-top: 15px;
            padding: 10px 30px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            display: inline-block;
            background: rgba(0, 212, 255, 0.05);
            animation: borderPulse 2s ease-in-out infinite;
        }

        @keyframes borderPulse {
            0%, 100% { border-color: rgba(0, 212, 255, 0.3); box-shadow: 0 0 10px rgba(0, 212, 255, 0.1); }
            50% { border-color: rgba(0, 212, 255, 0.6); box-shadow: 0 0 20px rgba(0, 212, 255, 0.3); }
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .nav-tab {
            font-family: 'Orbitron', monospace;
            font-size: clamp(0.7rem, 1.5vw, 0.9rem);
            padding: 12px 30px;
            background: transparent;
            border: 1px solid rgba(0, 212, 255, 0.3);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab:hover {
            border-color: var(--tron-cyan);
            color: var(--tron-cyan);
            box-shadow: var(--glow-cyan);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 136, 255, 0.1));
            border-color: var(--tron-cyan);
            color: var(--tron-cyan);
            box-shadow: var(--glow-cyan);
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .kpi-card {
            background: var(--bg-card);
            border: 1px solid rgba(0, 212, 255, 0.2);
            padding: 25px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--tron-cyan), transparent);
            animation: scanline 3s linear infinite;
        }

        @keyframes scanline {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .kpi-card:hover {
            border-color: var(--tron-cyan);
            box-shadow: var(--glow-cyan);
            transform: translateY(-5px);
        }

        .kpi-label {
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 10px;
        }

        .kpi-value {
            font-family: 'Orbitron', monospace;
            font-size: clamp(1.5rem, 3vw, 2.2rem);
            font-weight: 700;
            color: var(--tron-cyan);
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .kpi-value.negative {
            color: var(--tron-red);
            text-shadow: 0 0 20px rgba(255, 51, 102, 0.5);
        }

        .kpi-value.positive {
            color: var(--tron-green);
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto 40px;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid rgba(0, 212, 255, 0.2);
            padding: 25px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            border-color: rgba(0, 212, 255, 0.4);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.1);
        }

        .chart-title {
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            color: var(--tron-cyan);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 212, 255, 0.3);
        }

        .data-table td {
            font-size: 0.9rem;
            padding: 12px 8px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            transition: all 0.3s ease;
        }

        .data-table tr:hover td {
            background: rgba(0, 212, 255, 0.05);
        }

        .data-table .value {
            font-family: 'Orbitron', monospace;
            color: var(--tron-cyan);
        }

        .data-table .negative {
            color: var(--tron-red);
        }

        .data-table .positive {
            color: var(--tron-green);
        }

        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(0, 212, 255, 0.1);
            border-top-color: var(--tron-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-family: 'Orbitron', monospace;
            color: var(--tron-cyan);
            margin-top: 20px;
            font-size: 0.9rem;
            letter-spacing: 0.2em;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px;
            font-size: 0.8rem;
            color: rgba(136, 204, 255, 0.5);
            border-top: 1px solid rgba(0, 212, 255, 0.1);
            margin-top: 50px;
        }

        .last-updated {
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .data-source {
            font-size: 0.65rem;
            color: rgba(136, 204, 255, 0.4);
            margin-top: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
            }

            .header {
                padding: 20px 10px;
            }

            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .kpi-card {
                padding: 15px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .nav-tab {
                padding: 10px 15px;
                font-size: 0.65rem;
            }

            .data-table {
                font-size: 0.75rem;
            }

            .data-table th, .data-table td {
                padding: 8px 4px;
            }
        }

        /* Animated entry */
        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stagger-1 { animation-delay: 0.1s; }
        .stagger-2 { animation-delay: 0.2s; }
        .stagger-3 { animation-delay: 0.3s; }
        .stagger-4 { animation-delay: 0.4s; }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 212, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 212, 255, 0.5);
        }

        /* Error state */
        .error-message {
            text-align: center;
            padding: 40px;
            color: var(--tron-red);
            font-family: 'Orbitron', monospace;
        }

        .retry-btn {
            margin-top: 20px;
            padding: 12px 30px;
            background: transparent;
            border: 1px solid var(--tron-cyan);
            color: var(--tron-cyan);
            font-family: 'Orbitron', monospace;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .retry-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            box-shadow: var(--glow-cyan);
        }
    </style>
</head>
<body>
    <div class="grid-bg"></div>
    <div class="mouse-glow" id="mouseGlow"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, LineChart, Line, Legend } = Recharts;

        // ============================================
        // CONFIGURATION - YOUR GOOGLE SHEET GIDs
        // ============================================
        const SHEET_CONFIG = {
            // Your spreadsheet ID (from the publish URL)
            spreadsheetId: '2PACX-1vQn0tNOOEJD_zTR351vnZQ75dhN9Inhn7Yz_EnRbil4sIEWfIODpg_l9zZ02BlZ5nSAERlThepNRyO5',
            
            // Base URL for fetching CSV data
            baseUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQn0tNOOEJD_zTR351vnZQ75dhN9Inhn7Yz_EnRbil4sIEWfIODpg_l9zZ02BlZ5nSAERlThepNRyO5/pub',
            
            // Your Sheet GIDs
            sheets: {
                dashboardConfig: 1691965732,
                monthlySummary: 921362442,
                quarterlySummary: 331143112,
                annualSummary: 1672453392,
                shipmentsForecast: 1705716278
            }
        };

        // Tron color palette for charts
        const TRON_COLORS = [
            '#00d4ff', // Cyan
            '#0088ff', // Blue
            '#7b2fff', // Purple
            '#ff00ff', // Pink
            '#00ff88', // Green
            '#ff6600', // Orange
            '#ffcc00', // Yellow
            '#ff3366', // Red
            '#00ffcc', // Teal
        ];

        // ============================================
        // DATA FETCHING FUNCTIONS
        // ============================================
        const fetchSheetData = async (gid) => {
            const url = `${SHEET_CONFIG.baseUrl}?gid=${gid}&single=true&output=csv`;
            const response = await fetch(url);
            const csvText = await response.text();
            
            return new Promise((resolve, reject) => {
                Papa.parse(csvText, {
                    header: false,
                    skipEmptyLines: true,
                    complete: (results) => resolve(results.data),
                    error: (error) => reject(error)
                });
            });
        };

        const parseNumber = (value) => {
            if (!value) return 0;
            // Remove currency symbols, commas, parentheses (for negative)
            const cleaned = String(value).replace(/[$,\s]/g, '').replace(/\(([^)]+)\)/, '-$1');
            const num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
        };

        const parsePercent = (value) => {
            if (!value) return 0;
            const cleaned = String(value).replace(/[%\s]/g, '');
            const num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
        };

        // ============================================
        // PROCESS SHEET DATA INTO DASHBOARD FORMAT
        // ============================================
        const processMonthlyData = (data) => {
            // Data structure from Monthly Summary tab:
            // Row 4: B=Month, C=Year
            // Row 8: A=Revenue, C=Shipments, E=Profit, G=Margin
            // Rows 13-16: Product data (A=Name, B=Revenue, C=%, D=Shipments, E=AvgPrice, F=Profit, G=Margin)
            // Rows 22-30: Customer data (same structure)
            
            const selectedMonth = data[3] ? data[3][1] : 'December';
            const selectedYear = data[3] ? parseNumber(data[3][2]) : 2025;
            
            const totalRevenue = data[7] ? parseNumber(data[7][0]) : 0;
            const totalShipments = data[7] ? parseNumber(data[7][2]) : 0;
            const totalProfit = data[7] ? parseNumber(data[7][4]) : 0;
            const avgMargin = data[7] ? parsePercent(data[7][6]) : 0;
            
            // Parse products (rows 13-16, index 12-15)
            const products = [];
            for (let i = 12; i <= 15; i++) {
                if (data[i] && data[i][0]) {
                    products.push({
                        name: data[i][0],
                        revenue: parseNumber(data[i][1]),
                        pct: parsePercent(data[i][2]) * 100,
                        shipments: parseNumber(data[i][3]),
                        avgPrice: parseNumber(data[i][4]),
                        profit: parseNumber(data[i][5]),
                        margin: parsePercent(data[i][6]) * 100
                    });
                }
            }
            
            // Parse customers (rows 22-30, index 21-29)
            const customers = [];
            for (let i = 21; i <= 29; i++) {
                if (data[i] && data[i][0] && data[i][0] !== 'TOTAL') {
                    customers.push({
                        name: data[i][0],
                        revenue: parseNumber(data[i][1]),
                        pct: parsePercent(data[i][2]) * 100,
                        shipments: parseNumber(data[i][3]),
                        avgPrice: parseNumber(data[i][4]),
                        profit: parseNumber(data[i][5]),
                        margin: parsePercent(data[i][6]) * 100
                    });
                }
            }
            
            return {
                selectedMonth,
                selectedYear,
                totalRevenue,
                totalShipments,
                totalProfit,
                avgMargin: avgMargin * 100,
                products,
                customers
            };
        };

        const processQuarterlyData = (data) => {
            const selectedQuarter = data[3] ? data[3][1] : 'Q4';
            const selectedYear = data[3] ? parseNumber(data[3][2]) : 2025;
            
            const totalRevenue = data[7] ? parseNumber(data[7][0]) : 0;
            const totalShipments = data[7] ? parseNumber(data[7][2]) : 0;
            const totalProfit = data[7] ? parseNumber(data[7][4]) : 0;
            const avgMargin = data[7] ? parsePercent(data[7][6]) : 0;
            
            // Parse QoQ trend (rows 36-40, index 35-39)
            const trend = [];
            for (let i = 35; i <= 39; i++) {
                if (data[i] && data[i][0]) {
                    trend.push({
                        quarter: `${data[i][0]} ${data[i][1]}`,
                        revenue: parseNumber(data[i][2]),
                        shipments: parseNumber(data[i][3]),
                        profit: parseNumber(data[i][4])
                    });
                }
            }
            
            return {
                selectedQuarter,
                selectedYear,
                totalRevenue,
                totalShipments,
                totalProfit,
                avgMargin: avgMargin * 100,
                trend
            };
        };

        const processAnnualData = (data) => {
            const selectedYear = data[3] ? parseNumber(data[3][1]) : 2025;
            
            const totalRevenue = data[7] ? parseNumber(data[7][0]) : 0;
            const totalShipments = data[7] ? parseNumber(data[7][2]) : 0;
            const totalProfit = data[7] ? parseNumber(data[7][4]) : 0;
            const avgMargin = data[7] ? parsePercent(data[7][6]) : 0;
            
            // Parse monthly trend (rows 36-47, index 35-46)
            const monthlyTrend = [];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            for (let i = 35; i <= 46; i++) {
                if (data[i]) {
                    monthlyTrend.push({
                        month: months[i - 35] || data[i][0],
                        revenue: parseNumber(data[i][1]),
                        profit: parseNumber(data[i][3])
                    });
                }
            }
            
            // Parse YoY comparison (rows 53-56, index 52-55)
            const yearComparison = [];
            for (let i = 52; i <= 55; i++) {
                if (data[i] && data[i][0]) {
                    yearComparison.push({
                        year: String(data[i][0]),
                        revenue: parseNumber(data[i][1]),
                        profit: parseNumber(data[i][3])
                    });
                }
            }
            
            return {
                selectedYear,
                totalRevenue,
                totalShipments,
                totalProfit,
                avgMargin: avgMargin * 100,
                monthlyTrend,
                yearComparison
            };
        };

        const processConfigData = (data) => {
            return {
                currentMonth: data[0] ? data[0][1] : 'December',
                currentYear: data[1] ? parseNumber(data[1][1]) : 2025,
                lastUpdated: data[2] ? data[2][1] : new Date().toLocaleString()
            };
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        const formatCurrency = (value) => {
            if (value === null || value === undefined || isNaN(value)) return '$0';
            const absValue = Math.abs(value);
            const formatted = absValue >= 1000000 
                ? `$${(absValue / 1000000).toFixed(2)}M`
                : absValue >= 1000 
                    ? `$${(absValue / 1000).toFixed(1)}K`
                    : `$${absValue.toFixed(0)}`;
            return value < 0 ? `-${formatted}` : formatted;
        };

        const formatNumber = (value) => {
            if (value === null || value === undefined || isNaN(value)) return '0';
            return Math.round(value).toLocaleString('en-US');
        };

        const formatPercent = (value) => {
            if (value === null || value === undefined || isNaN(value)) return '0%';
            return `${value >= 0 ? '' : ''}${value.toFixed(1)}%`;
        };

        // ============================================
        // ANIMATED COUNTER COMPONENT
        // ============================================
        const AnimatedCounter = ({ value, formatter = formatNumber, duration = 1500 }) => {
            const [displayValue, setDisplayValue] = useState(0);
            const startTime = useRef(null);
            const animationFrame = useRef(null);

            useEffect(() => {
                const animate = (timestamp) => {
                    if (!startTime.current) startTime.current = timestamp;
                    const progress = Math.min((timestamp - startTime.current) / duration, 1);
                    const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                    setDisplayValue(value * easeOutQuart);
                    
                    if (progress < 1) {
                        animationFrame.current = requestAnimationFrame(animate);
                    }
                };

                startTime.current = null;
                animationFrame.current = requestAnimationFrame(animate);

                return () => {
                    if (animationFrame.current) {
                        cancelAnimationFrame(animationFrame.current);
                    }
                };
            }, [value, duration]);

            return <span>{formatter(displayValue)}</span>;
        };

        // ============================================
        // KPI CARD COMPONENT
        // ============================================
        const KPICard = ({ label, value, formatter, isProfit = false, delay = 0 }) => {
            const numValue = typeof value === 'string' ? parseFloat(value.replace(/[^0-9.-]/g, '')) : value;
            const isNegative = isProfit && numValue < 0;
            const isPositive = isProfit && numValue > 0;

            return (
                <div className={`kpi-card fade-in stagger-${delay}`}>
                    <div className="kpi-label">{label}</div>
                    <div className={`kpi-value ${isNegative ? 'negative' : ''} ${isPositive ? 'positive' : ''}`}>
                        <AnimatedCounter value={numValue} formatter={formatter} />
                    </div>
                </div>
            );
        };

        // ============================================
        // CUSTOM TOOLTIP FOR CHARTS
        // ============================================
        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                return (
                    <div style={{
                        background: 'rgba(0, 20, 40, 0.95)',
                        border: '1px solid #00d4ff',
                        padding: '12px 16px',
                        fontFamily: 'Orbitron, monospace',
                        fontSize: '0.8rem',
                        boxShadow: '0 0 20px rgba(0, 212, 255, 0.3)'
                    }}>
                        <p style={{ color: '#00d4ff', marginBottom: '5px' }}>{label || payload[0].name}</p>
                        {payload.map((entry, index) => (
                            <p key={index} style={{ color: entry.color || '#fff' }}>
                                {entry.dataKey || 'Value'}: {formatCurrency(entry.value)}
                            </p>
                        ))}
                    </div>
                );
            }
            return null;
        };

        // ============================================
        // PIE CHART COMPONENT
        // ============================================
        const TronPieChart = ({ data, dataKey = 'value', nameKey = 'name', title }) => {
            const validData = data.filter(d => d[dataKey] > 0);
            
            return (
                <div className="chart-card">
                    <h3 className="chart-title">{title}</h3>
                    <ResponsiveContainer width="100%" height={280}>
                        <PieChart>
                            <Pie
                                data={validData}
                                dataKey={dataKey}
                                nameKey={nameKey}
                                cx="50%"
                                cy="50%"
                                outerRadius={100}
                                innerRadius={50}
                                paddingAngle={2}
                                animationBegin={200}
                                animationDuration={1500}
                            >
                                {validData.map((entry, index) => (
                                    <Cell 
                                        key={`cell-${index}`} 
                                        fill={TRON_COLORS[index % TRON_COLORS.length]}
                                        stroke="rgba(0, 20, 40, 0.8)"
                                        strokeWidth={2}
                                    />
                                ))}
                            </Pie>
                            <Tooltip content={<CustomTooltip />} />
                            <Legend 
                                wrapperStyle={{ 
                                    fontFamily: 'Rajdhani, sans-serif',
                                    fontSize: '0.8rem'
                                }}
                            />
                        </PieChart>
                    </ResponsiveContainer>
                </div>
            );
        };

        // ============================================
        // BAR CHART COMPONENT
        // ============================================
        const TronBarChart = ({ data, dataKey = 'value', nameKey = 'name', title, showNegative = false }) => {
            return (
                <div className="chart-card">
                    <h3 className="chart-title">{title}</h3>
                    <ResponsiveContainer width="100%" height={280}>
                        <BarChart data={data} margin={{ top: 20, right: 30, left: 20, bottom: 60 }}>
                            <XAxis 
                                dataKey={nameKey} 
                                tick={{ fill: '#88ccff', fontSize: 10, fontFamily: 'Rajdhani' }}
                                angle={-45}
                                textAnchor="end"
                                interval={0}
                                height={60}
                            />
                            <YAxis 
                                tick={{ fill: '#88ccff', fontSize: 10, fontFamily: 'Orbitron' }}
                                tickFormatter={(value) => formatCurrency(value)}
                            />
                            <Tooltip content={<CustomTooltip />} />
                            <Bar 
                                dataKey={dataKey} 
                                animationBegin={300}
                                animationDuration={1500}
                            >
                                {data.map((entry, index) => (
                                    <Cell 
                                        key={`cell-${index}`} 
                                        fill={showNegative && entry[dataKey] < 0 ? '#ff3366' : '#00d4ff'}
                                    />
                                ))}
                            </Bar>
                        </BarChart>
                    </ResponsiveContainer>
                </div>
            );
        };

        // ============================================
        // LINE CHART COMPONENT
        // ============================================
        const TronLineChart = ({ data, lines, xKey = 'name', title }) => {
            return (
                <div className="chart-card">
                    <h3 className="chart-title">{title}</h3>
                    <ResponsiveContainer width="100%" height={280}>
                        <LineChart data={data} margin={{ top: 20, right: 30, left: 20, bottom: 20 }}>
                            <XAxis 
                                dataKey={xKey} 
                                tick={{ fill: '#88ccff', fontSize: 10, fontFamily: 'Rajdhani' }}
                            />
                            <YAxis 
                                tick={{ fill: '#88ccff', fontSize: 10, fontFamily: 'Orbitron' }}
                                tickFormatter={(value) => formatCurrency(value)}
                            />
                            <Tooltip content={<CustomTooltip />} />
                            <Legend />
                            {lines.map((line, index) => (
                                <Line 
                                    key={line.key}
                                    type="monotone"
                                    dataKey={line.key}
                                    stroke={TRON_COLORS[index]}
                                    strokeWidth={2}
                                    dot={{ fill: TRON_COLORS[index], strokeWidth: 2, r: 4 }}
                                    activeDot={{ r: 6, stroke: '#fff', strokeWidth: 2 }}
                                    animationBegin={400}
                                    animationDuration={1500}
                                />
                            ))}
                        </LineChart>
                    </ResponsiveContainer>
                </div>
            );
        };

        // ============================================
        // DATA TABLE COMPONENT
        // ============================================
        const DataTable = ({ data, columns, title }) => {
            return (
                <div className="chart-card">
                    <h3 className="chart-title">{title}</h3>
                    <div style={{ overflowX: 'auto' }}>
                        <table className="data-table">
                            <thead>
                                <tr>
                                    {columns.map((col, i) => (
                                        <th key={i}>{col.header}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {data.map((row, rowIndex) => (
                                    <tr key={rowIndex}>
                                        {columns.map((col, colIndex) => {
                                            const value = row[col.key];
                                            let className = '';
                                            let displayValue = value;

                                            if (col.type === 'currency') {
                                                displayValue = formatCurrency(value);
                                                className = `value ${value < 0 ? 'negative' : value > 0 ? 'positive' : ''}`;
                                            } else if (col.type === 'percent') {
                                                displayValue = `${value?.toFixed(1) || 0}%`;
                                                className = `value ${value < 0 ? 'negative' : value > 0 ? 'positive' : ''}`;
                                            } else if (col.type === 'number') {
                                                displayValue = formatNumber(value);
                                                className = 'value';
                                            }

                                            return (
                                                <td key={colIndex} className={className}>
                                                    {displayValue}
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // ============================================
        // MONTHLY VIEW COMPONENT
        // ============================================
        const MonthlyView = ({ data }) => {
            const productChartData = data.products.map(p => ({ name: p.name, value: p.revenue }));
            const customerChartData = data.customers.map(c => ({ name: c.name, value: c.revenue }));
            const profitChartData = data.products.map(p => ({ name: p.name, profit: p.profit }));

            const productColumns = [
                { header: 'Product', key: 'name', type: 'text' },
                { header: 'Revenue', key: 'revenue', type: 'currency' },
                { header: '% Share', key: 'pct', type: 'percent' },
                { header: 'Shipments', key: 'shipments', type: 'number' },
                { header: 'Profit', key: 'profit', type: 'currency' },
                { header: 'Margin', key: 'margin', type: 'percent' },
            ];

            const customerColumns = [
                { header: 'Customer', key: 'name', type: 'text' },
                { header: 'Revenue', key: 'revenue', type: 'currency' },
                { header: '% Share', key: 'pct', type: 'percent' },
                { header: 'Profit', key: 'profit', type: 'currency' },
                { header: 'Margin', key: 'margin', type: 'percent' },
            ];

            return (
                <>
                    <div className="kpi-grid">
                        <KPICard label="Total Revenue" value={data.totalRevenue} formatter={formatCurrency} delay={1} />
                        <KPICard label="Total Shipments (GT)" value={data.totalShipments} formatter={formatNumber} delay={2} />
                        <KPICard label="Total Profit" value={data.totalProfit} formatter={formatCurrency} isProfit={true} delay={3} />
                        <KPICard label="Average Margin" value={data.avgMargin} formatter={(v) => formatPercent(v)} isProfit={true} delay={4} />
                    </div>

                    <div className="charts-grid">
                        <TronPieChart data={productChartData} title="Revenue by Product" />
                        <TronPieChart data={customerChartData} title="Revenue by Customer" />
                    </div>

                    <div className="charts-grid">
                        <TronBarChart 
                            data={profitChartData} 
                            dataKey="profit" 
                            nameKey="name" 
                            title="Profit by Product" 
                            showNegative={true}
                        />
                        <DataTable data={data.products} columns={productColumns} title="Product Performance" />
                    </div>

                    <div className="charts-grid">
                        <DataTable data={data.customers} columns={customerColumns} title="Customer Performance" />
                    </div>
                </>
            );
        };

        // ============================================
        // QUARTERLY VIEW COMPONENT
        // ============================================
        const QuarterlyView = ({ data, monthlyData }) => {
            const productChartData = monthlyData.products.map(p => ({ name: p.name, value: p.revenue }));
            const trendData = data.trend.filter(t => t.revenue > 0);

            return (
                <>
                    <div className="kpi-grid">
                        <KPICard label="Quarterly Revenue" value={data.totalRevenue} formatter={formatCurrency} delay={1} />
                        <KPICard label="Quarterly Shipments (GT)" value={data.totalShipments} formatter={formatNumber} delay={2} />
                        <KPICard label="Quarterly Profit" value={data.totalProfit} formatter={formatCurrency} isProfit={true} delay={3} />
                        <KPICard label="Average Margin" value={data.avgMargin} formatter={(v) => formatPercent(v)} isProfit={true} delay={4} />
                    </div>

                    <div className="charts-grid">
                        <TronPieChart data={productChartData} title="Revenue by Product (Quarter)" />
                        <TronBarChart 
                            data={trendData} 
                            dataKey="revenue" 
                            nameKey="quarter" 
                            title="Quarter-over-Quarter Revenue" 
                        />
                    </div>

                    {trendData.length > 1 && (
                        <div className="charts-grid">
                            <TronLineChart 
                                data={trendData}
                                lines={[
                                    { key: 'revenue', name: 'Revenue' },
                                    { key: 'profit', name: 'Profit' }
                                ]}
                                xKey="quarter"
                                title="Quarterly Trend"
                            />
                        </div>
                    )}
                </>
            );
        };

        // ============================================
        // ANNUAL VIEW COMPONENT
        // ============================================
        const AnnualView = ({ data, monthlyData }) => {
            const productChartData = monthlyData.products.map(p => ({ name: p.name, value: p.revenue }));
            const monthlyWithData = data.monthlyTrend.filter(m => m.revenue > 0);
            const yearsWithData = data.yearComparison.filter(y => y.revenue > 0);

            return (
                <>
                    <div className="kpi-grid">
                        <KPICard label="Annual Revenue" value={data.totalRevenue} formatter={formatCurrency} delay={1} />
                        <KPICard label="Annual Shipments (GT)" value={data.totalShipments} formatter={formatNumber} delay={2} />
                        <KPICard label="Annual Profit" value={data.totalProfit} formatter={formatCurrency} isProfit={true} delay={3} />
                        <KPICard label="Average Margin" value={data.avgMargin} formatter={(v) => formatPercent(v)} isProfit={true} delay={4} />
                    </div>

                    <div className="charts-grid">
                        <TronPieChart data={productChartData} title="Revenue by Product (Year)" />
                        <TronBarChart 
                            data={data.monthlyTrend} 
                            dataKey="revenue" 
                            nameKey="month" 
                            title="Monthly Revenue Trend" 
                        />
                    </div>

                    <div className="charts-grid">
                        <TronBarChart 
                            data={data.monthlyTrend} 
                            dataKey="profit" 
                            nameKey="month" 
                            title="Monthly Profit Trend" 
                            showNegative={true}
                        />
                        {yearsWithData.length > 0 && (
                            <TronBarChart 
                                data={yearsWithData} 
                                dataKey="revenue" 
                                nameKey="year" 
                                title="Year-over-Year Comparison" 
                            />
                        )}
                    </div>
                </>
            );
        };

        // ============================================
        // MAIN APP COMPONENT
        // ============================================
        const App = () => {
            const [activeTab, setActiveTab] = useState('monthly');
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            // Mouse follower effect
            useEffect(() => {
                const handleMouseMove = (e) => {
                    const glow = document.getElementById('mouseGlow');
                    if (glow) {
                        glow.style.left = e.clientX + 'px';
                        glow.style.top = e.clientY + 'px';
                    }
                };

                window.addEventListener('mousemove', handleMouseMove);
                return () => window.removeEventListener('mousemove', handleMouseMove);
            }, []);

            // Fetch data from Google Sheets
            const fetchAllData = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    // Fetch all sheets in parallel
                    const [configData, monthlyData, quarterlyData, annualData] = await Promise.all([
                        fetchSheetData(SHEET_CONFIG.sheets.dashboardConfig),
                        fetchSheetData(SHEET_CONFIG.sheets.monthlySummary),
                        fetchSheetData(SHEET_CONFIG.sheets.quarterlySummary),
                        fetchSheetData(SHEET_CONFIG.sheets.annualSummary)
                    ]);
                    
                    // Process the data
                    const processedData = {
                        config: processConfigData(configData),
                        monthly: processMonthlyData(monthlyData),
                        quarterly: processQuarterlyData(quarterlyData),
                        annual: processAnnualData(annualData)
                    };
                    
                    console.log('Fetched data:', processedData);
                    setData(processedData);
                    setLoading(false);
                } catch (err) {
                    console.error('Error fetching data:', err);
                    setError(err.message || 'Failed to fetch data from Google Sheets');
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchAllData();
            }, []);

            if (loading) {
                return (
                    <div className="app-container">
                        <div className="loading">
                            <div className="loading-spinner"></div>
                            <div className="loading-text">LOADING DATA FROM SHEETS</div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="app-container">
                        <header className="header">
                            <h1 className="logo">ENTECH</h1>
                            <p className="subtitle">Metal Sales Dashboard</p>
                        </header>
                        <div className="error-message">
                            <h2>CONNECTION ERROR</h2>
                            <p style={{ marginTop: '10px' }}>{error}</p>
                            <p style={{ marginTop: '20px', fontSize: '0.8rem', color: '#88ccff' }}>
                                Make sure your Google Sheet is published to the web.
                            </p>
                            <button className="retry-btn" onClick={fetchAllData}>
                                RETRY CONNECTION
                            </button>
                        </div>
                    </div>
                );
            }

            if (!data) return null;

            return (
                <div className="app-container">
                    <header className="header">
                        <h1 className="logo">ENTECH</h1>
                        <p className="subtitle">Metal Sales Dashboard</p>
                        <div className="current-period">
                            {data.config.currentMonth} {data.config.currentYear}
                        </div>
                    </header>

                    <nav className="nav-tabs">
                        <button 
                            className={`nav-tab ${activeTab === 'monthly' ? 'active' : ''}`}
                            onClick={() => setActiveTab('monthly')}
                        >
                            Monthly
                        </button>
                        <button 
                            className={`nav-tab ${activeTab === 'quarterly' ? 'active' : ''}`}
                            onClick={() => setActiveTab('quarterly')}
                        >
                            Quarterly
                        </button>
                        <button 
                            className={`nav-tab ${activeTab === 'annual' ? 'active' : ''}`}
                            onClick={() => setActiveTab('annual')}
                        >
                            Annual
                        </button>
                    </nav>

                    <main>
                        {activeTab === 'monthly' && <MonthlyView data={data.monthly} />}
                        {activeTab === 'quarterly' && <QuarterlyView data={data.quarterly} monthlyData={data.monthly} />}
                        {activeTab === 'annual' && <AnnualView data={data.annual} monthlyData={data.monthly} />}
                    </main>

                    <footer className="footer">
                        <p>ENTECH Metal Sales Dashboard</p>
                        <p className="last-updated">Last Updated: {data.config.lastUpdated}</p>
                        <p className="data-source">Data Source: Google Sheets (Live)</p>
                    </footer>
                </div>
            );
        };

        // Render the app
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
